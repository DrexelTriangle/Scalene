---
export const prerender = false;

const {sections, article} = Astro.params

import BaseLayout from "../../layouts/BaseLayout.astro";
import Header from '../../components/Header.astro';
import '../../styles/global.css';
import { getArticle } from '../../utils/db';
import { normalizeText } from "../../utils/data";

const post = await getArticle(article);

if (!post) {
  return Astro.rewrite('/404');
}

let authorListLinks = [];
let authorList = post.authors.forEach((author)=>{authorListLinks.push(`<a class='hover:underline' href='/authors/${author.id}'>${author.name}</a>`);})

let d = new Date(post.date)
const months = ["Jan.", "Feb.", "March", "April", "May", "June", "July", "Aug.", "Sep.", "Oct.", "Nov.", "Dec."];
const date_string = months[d.getMonth()] + " " + d.getDate() + ", " + d.getFullYear();

authorList = authorListLinks.join(" and ") + " | " + date_string;
---
<BaseLayout title={normalizeText(post.title) + " - The Triangle"}>
    <Header/>
    <article class="xl:max-w-[1200px] lg:max-w-[900px] max-w-[90%] mx-[auto]">
        {post.categories_list && <a href={"../"+post.categories_list[0].slug}><span class="block font-roboto-slab uppercase font-extrabold text-triangleBlue text-[14px] italic font-700"> {normalizeText(post.categories_list[0].name)} </span></a>}
        <h1 class="font-playfair text-[42px] font-bold mt-[-12px]">{normalizeText(post.title)}</h1>
        <div set:html={authorList} class="text-[18px] mb-[16px] font-roboto-slab font-light"></div>
        <section id="article" set:html={post.content.replaceAll("https://cms.thetriangle.org/wp-content", "/proxy/wp-content").replaceAll("https://www.thetriangle.org/wp-content", "/proxy/wp-content").replace(/srcset="[^"]*"/g, "")}>

        </section>
        {post.content.includes('pm-embed-div') && (
        <script 
            is:inline 
            id="pm-script" 
            src="https://puzzleme.amuselabs.com/pmm/js/puzzleme-embed.js"
        ></script>)}
    </article>
</BaseLayout>