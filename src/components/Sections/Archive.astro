---
    export const prerender = false; // Not needed in 'server' mode
    const { pageNum, hasMore, sectionSlug, url } = Astro.props;
---

<div id="article-loader" style="display: none;">
    Loading more articles...
</div>
<script define:vars={{ pageNum, hasMore, sectionSlug, url }}>
        let isLoading = false;
        let currentPage = 2;
        let localHasMore = hasMore;

        const articleLoader = document.getElementById("article-loader");
        const articlesGrid = document.getElementById("main-left");

        const fetchMoreArticles = async () => {
            console.log("running");
            if (isLoading || !localHasMore) return;

            isLoading = true;
            articleLoader.style.display = "block";

            try {
                const response = await fetch(
                    `${url}${sectionSlug}?page=${currentPage}`,
                );
                const data = await response.json();

                if (!data.articles || data.articles.length === 0) {
                    localHasMore = false;
                } else {
                    currentPage++;
                    data.articles.forEach((article) => {
                        const articleElement =
                            document.createElement("article");
                        let authorListLinks = [];
                        let author = article.authors;
                        let authorList = author.forEach((author) => {
                            authorListLinks.push(
                                `<a class='hover:underline' href='/author/${author.slug}'>${author.name}</a>`,
                            );
                        });

                        if (authorListLinks.length > 1) {
                            authorListLinks[authorListLinks.length - 1] =
                                " and " +
                                authorListLinks[authorListLinks.length - 1];
                        }

                        let d = new Date(article.date);
                        let months = [
                            "Jan.",
                            "Feb.",
                            "March",
                            "April",
                            "May",
                            "June",
                            "July",
                            "Aug.",
                            "Sep.",
                            "Oct.",
                            "Nov.",
                            "Dec.",
                        ];
                        let date_string =
                            months[d.getMonth()] +
                            " " +
                            d.getDate() +
                            ", " +
                            d.getFullYear();

                        authorList =
                            authorListLinks.length > 2
                                ? authorListLinks.join(", ") +
                                  " | " +
                                  date_string
                                : authorListLinks.join("") +
                                  " | " +
                                  date_string;
                        articleElement.innerHTML = `
                            <article class="grid grid-cols-[5fr_3fr] py-[8px] border-b-[1px] border-solid border-triangleGray-400">
                                <div class="md:pr-[12px]">
                                    <a href='${"/" + sectionSlug + "/" + article.slug}'><h2 class="font-playfair text-[28px] leading-tight hover:underline mb-[8px]">${article.title}</h2><a>
                                    <div id="byline" class="font-roboto-slab text-[12px] mb-[8px]">${authorList}</div>
                                    <div class="text-[14px]"> ${article.excerpt} </div>
                                </div>
                                <img src=${article.featured_image ? article.featured_image.replace("https://www.thetriangle.org", "/proxy").replace("https://cms.thetriangle.org", "/proxy") : "/proxy/wp-content/uploads/2024/12/IMG_2493-2048x1365.jpg"} alt="article image" class="ml-[12px] bg-[url('/images/loading.jpg')] bg-cover w-[calc(100%-12px)] h-[169px] object-cover"/>
                            </article>
                        `;
                        articlesGrid.appendChild(articleElement);
                    });
                }
            } catch (error) {
                console.error("Error fetching articles:", error);
                localHasMore = false;
            } finally {
                isLoading = false;
                articleLoader.style.display = localHasMore ? "none" : "block";
                articleLoader.textContent = localHasMore
                    ? "Loading more articles..."
                    : "";

                if (!localHasMore) {
                    window.removeEventListener("scroll", handleScroll);
                    console.log("No more articles, removed scroll listener");
                }
            }
        };

        const handleScroll = () => {
            if (isLoading || !localHasMore) return;

            const scrollHeight = document.documentElement.scrollHeight;
            const scrollTop =
                window.scrollY || document.documentElement.scrollTop;
            const clientHeight =
                window.innerHeight || document.documentElement.clientHeight;

            if (scrollTop + clientHeight >= scrollHeight - 400) {
                console.log(`Triggering fetch for page ${currentPage + 1}`);
                fetchMoreArticles();
            }
        };

        window.addEventListener("scroll", handleScroll);
    </script>